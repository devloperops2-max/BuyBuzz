
/**
 * @file Firestore Security Rules for Nova Emporium.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles and orders,
 * while allowing public read access to product information.
 *
 * @data_structure Data is organized hierarchically:
 *   - /users/{userId}: Stores individual user profiles.
 *   - /products/{productId}: Stores publicly accessible product information.
 *   - /users/{userId}/orders/{orderId}: Stores order information for each user.
 *   - /users/{userId}/orders/{orderId}/orderItems/{orderItemId}: Stores individual order items.
 *   - /users/{userId}/orders/{orderId}/orderStatuses/{orderStatusId}: Stores the history of order statuses.
 *
 * @key_security_decisions
 *   - Users can only read and write their own profile data.
 *   - Products are publicly readable.
 *   - Any user can write to the products collection to allow for seeding.
 *   - Users can only read and write their own order data.
 *   - Listing all users is disallowed.
 *
 * @denormalization_for_authorization  The data structure avoids the need for `get()` calls in the security rules.  Specifically,
 * order data is nested under the user's ID, allowing rules to easily verify the user's ownership of the order using path-based
 * authorization. No explicit group membership is defined, but path-based ownership ensures all user-created data is owned by the
 * user ID.
 *
 * @structural_segregation Publicly readable product information is stored in a top-level collection separate from private user data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create, update, get, list) User with ID 'user123' can create/update/get their own profile.
     *   Request: `auth.uid == 'user123'`, `resource.data.id == 'user123'` (on create/update).
     * @deny (create, update, get, list) User with ID 'user456' cannot access user 'user123' profile.
     *   Request: `auth.uid == 'user456'` trying to access `/users/user123`.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to product information.
     * @path /products/{productId}
     * @allow (get, list) Any user can view product details and list all products.
     * @allow (create, update, delete) Allow writes for seeding purposes.
     * @principle Allows public read access to product information and write for authenticated users.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow write: if true;
    }

    /**
     * @description Controls access to shopping cart items for each user.
     * @path /users/{userId}/cart/{productId}
     * @allow User can manage their own cart items.
     * @principle Enforces document ownership for the shopping cart.
     */
    match /users/{userId}/cart/{productId} {
       function isOwner(userId) {
            return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
            return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);

        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }


    /**
     * @description Controls access to order information for each user.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create, update, get, list) User with ID 'user123' can create/update/get their own orders.
     *   Request: `auth.uid == 'user123'` accessing `/users/user123/orders/...`.
     * @deny (create, update, get, list) User with ID 'user456' cannot access user 'user123' orders.
     *   Request: `auth.uid == 'user456'` trying to access `/users/user123/orders/...`.
     * @principle Enforces document ownership for orders.
     */
    match /users/{userId}/orders/{orderId} {
        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
            return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);

        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to order item information for each order.
     * @path /users/{userId}/orders/{orderId}/orderItems/{orderItemId}
     * @allow (create, update, get, list) User with ID 'user123' can create/update/get their own order items.
     *   Request: `auth.uid == 'user123'` accessing `/users/user123/orders/{orderId}/orderItems/...`.
     * @deny (create, update, get, list) User with ID 'user456' cannot access user 'user123' order items.
     *   Request: `auth.uid == 'user456'` trying to access `/users/user123/orders/{orderId}/orderItems/...`.
     * @principle Enforces document ownership for order items.
     */
    match /users/{userId}/orders/{orderId}/orderItems/{orderItemId} {
        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
            return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);

        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to order status information for each order.
     * @path /users/{userId}/orders/{orderId}/orderStatuses/{orderStatusId}
     * @allow (create, update, get, list) User with ID 'user123' can create/update/get their own order statuses.
     *   Request: `auth.uid == 'user123'` accessing `/users/user123/orders/{orderId}/orderStatuses/...`.
     * @deny (create, update, get, list) User with ID 'user456' cannot access user 'user123' order statuses.
     *   Request: `auth.uid == 'user456'` trying to access `/users/user123/orders/{orderId}/orderStatuses/...`.
     * @principle Enforces document ownership for order statuses.
     */
    match /users/{userId}/orders/{orderId}/orderStatuses/{orderStatusId} {
        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
            return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);

        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }
  }
}
